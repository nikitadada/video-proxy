<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Echo Fix</title>
</head>
<body style="background: #121212; color: white; font-family: sans-serif; text-align: center;">
<h1>WebRTC Echo Test (Final Fix)</h1>
<div style="display: flex; justify-content: center; gap: 20px;">
    <div>
        <p>Local Camera</p>
        <video id="localVideo" autoplay muted playsinline style="width: 400px; border: 2px solid #ff4444; background: black;"></video>
    </div>
    <div>
        <p>Remote Echo</p>
        <video id="remoteVideo" autoplay playsinline style="width: 400px; border: 2px solid #44ff44; background: black;"></video>
    </div>
</div>

<script>
    async function start() {
        const pc = new RTCPeerConnection({
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞
        pc.ontrack = (event) => {
            console.log("üì• –ü—Ä–∏—à–µ–ª —Ç—Ä–µ–∫ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", event.track.kind);
            const remoteVideo = document.getElementById('remoteVideo');
            if (!remoteVideo.srcObject) {
                remoteVideo.srcObject = new MediaStream();
            }
            remoteVideo.srcObject.addTrack(event.track);
            remoteVideo.play().catch(e => console.error("Play error:", e));
        };

        // 1. –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        document.getElementById('localVideo').srcObject = stream;

        // 2. –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–¥–µ–∫–∏
        stream.getTracks().forEach(track => {
            const transceiver = pc.addTransceiver(track, {
                direction: 'sendrecv',
                streams: [stream]
            });

            // –§–ò–ö–° –ö–û–î–ï–ö–û–í: –ó–∞—Å—Ç–∞–≤–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—ã–π H.264
            if (RTCRtpReceiver.getCapabilities) {
                const capabilities = RTCRtpReceiver.getCapabilities('video');
                const codecs = capabilities.codecs.filter(c =>
                    c.mimeType === 'video/H264' &&
                    c.sdpFmtpLine && c.sdpFmtpLine.includes('profile-level-id=42e01f')
                );
                if (codecs.length > 0) {
                    transceiver.setCodecPreferences(codecs);
                    console.log("‚úÖ –ö–æ–¥–µ–∫ H.264 Baseline —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
                }
            }
        });

        // 3. Signaling
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        const response = await fetch('/webrtc', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(pc.localDescription)
        });

        const answer = await response.json();
        await pc.setRemoteDescription(answer);

        console.log("üöÄ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
    }

    start().catch(console.error);
</script>
</body>
</html>
