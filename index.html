<!DOCTYPE html>
<html>
<head>
    <title>WebRTC SFU Final Debug</title>
</head>
<body style="background: #121212; color: white; font-family: sans-serif; text-align: center;">
<h1>Room: <span id="rname"></span></h1>
<div id="grid" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 20px;">
    <video id="local" autoplay muted playsinline style="width: 300px; border: 2px solid red; border-radius: 8px;"></video>
</div>

<script>
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    const urlParams = new URLSearchParams(window.location.search);
    const room = urlParams.get('room') || 'default';
    document.getElementById('rname').innerText = room;

    window.pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ PeerConnection
    window.pc.oniceconnectionstatechange = () => console.log("üìç ICE Status:", window.pc.iceConnectionState);
    window.pc.onsignalingstatechange = () => console.log("üí° Signaling:", window.pc.signalingState);

    window.pc.ontrack = (event) => {
        console.log("üì∫ –ü–û–õ–£–ß–ï–ù –¢–†–ï–ö –û–¢ –°–ï–†–í–ï–†–ê:", event.track.id);

        // –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –ø–æ ID —Ç—Ä–µ–∫–∞, –æ–Ω –≤—Å–µ–≥–¥–∞ —É–Ω–∏–∫–∞–ª–µ–Ω
        const trackId = event.track.id;
        console.log("üì∫ –ü–æ–ª—É—á–µ–Ω —Ç—Ä–µ–∫:", trackId);

        if (document.getElementById(trackId)) return;

        const v = document.createElement('video');
        v.id = trackId; // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º ID –∫ —Ç—Ä–µ–∫—É
        v.srcObject = event.streams[0]; // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Å—Ç—Ä–∏–º
        v.autoplay = true;
        v.playsinline = true;
        v.style.width = "300px";
        v.style.border = "2px solid green";
        v.style.margin = "5px";
        document.getElementById('grid').appendChild(v);
    };

    // 3. –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞
    async function start() {
        try {
            // –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∫–∞–º–µ—Ä—É
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            console.log("üì∑ –ö–∞–º–µ—Ä–∞ –ø–æ–ª—É—á–µ–Ω–∞, —Ç—Ä–µ–∫–æ–≤:", stream.getVideoTracks().length);
            document.getElementById('local').srcObject = stream;

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏ –î–û —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ñ—Ñ–µ—Ä–∞
            stream.getTracks().forEach(track => window.pc.addTrack(track, stream));

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º WebSocket
            const ws = new WebSocket(`ws://${location.host}/ws?room=${room}`);

            window.pc.onicecandidate = (e) => {
                if (e.candidate && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate }));
                }
            };

            ws.onopen = async () => {
                console.log("üîå WS –æ—Ç–∫—Ä—ã—Ç, —Å–æ–∑–¥–∞–µ–º Offer...");
                const offer = await window.pc.createOffer();

                if (!offer.sdp.includes("m=video")) {
                    console.error("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –í SDP –Ω–µ—Ç –≤–∏–¥–µ–æ-—Å–µ–∫—Ü–∏–∏!");
                }

                await window.pc.setLocalDescription(offer);
                ws.send(JSON.stringify({ type: 'offer', sdp: window.pc.localDescription.sdp }));
            };

            ws.onmessage = async (e) => {
                const msg = JSON.parse(e.data);
                console.log("üì© –ü—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", msg.type);

                if (msg.type === 'offer') {
                    await window.pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: msg.sdp }));
                    const answer = await window.pc.createAnswer();
                    await window.pc.setLocalDescription(answer);
                    ws.send(JSON.stringify({ type: 'answer', sdp: window.pc.localDescription.sdp }));
                } else if (msg.type === 'answer') {
                    await window.pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: msg.sdp }));
                } else if (msg.type === 'candidate') {
                    await window.pc.addIceCandidate(msg.candidate).catch(console.error);
                } else if (msg.type === 'peer-left') {
                    console.log("–£–¥–∞–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞:", msg.peerId); // 'p' - —Å—Ç—Ä–æ—á–Ω–∞—è
                    const videos = document.querySelectorAll('video:not(#local)');
                    videos.forEach(v => {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º id –≤–∏–¥–µ–æ –∏–ª–∏ id —Å—Ç—Ä–∏–º–∞
                        if (v.id.includes(msg.peerId) || (v.srcObject && v.srcObject.id.includes(msg.peerId))) {
                            v.remove();
                        }
                    });
                }
            };

        } catch (err) {
            console.error("‚ùå –û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞:", err);
        }
    }

    start();
</script>
</body>
</html>
